# ƒê√¢y l√† m·ªôt ghi ch√∫ cho to√†n b·ªô t·ªáp YAML

name: Cloudflare API Usage # ƒê√¢y l√† ghi ch√∫ cho m·ªôt d√≤ng c·ª• th·ªÉ

on:
  schedule:
    - cron: '25 1 * * *'  # Ch·∫°y cron job v√†o l√∫c 01:25 m·ªói ng√†y
    - cron: '0 10 * * *'  # Ch·∫°y cron job v√†o l√∫c 10:00 m·ªói ng√†y
    - cron: '0 17 * * *'  # Ch·∫°y cron job v√†o l√∫c 17:00 m·ªói ng√†y
    - cron: '0 20 * * *'  # Ch·∫°y cron job v√†o l√∫c 20:00 m·ªói ng√†y
  workflow_dispatch:  # K√≠ch ho·∫°t workflow b·∫±ng c√°ch th·ªß c√¥ng

jobs:
  query-and-send:
    runs-on: ubuntu-latest  # S·ª≠ d·ª•ng m√¥i tr∆∞·ªùng Ubuntu m·ªõi nh·∫•t

    env:
      API_EMAIL: ${{ secrets.API_EMAIL }}  # Email API t·ª´ secrets
      API_KEY: ${{ secrets.API_KEY }}  # API key t·ª´ secrets
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}  # ID t√†i kho·∫£n t·ª´ secrets
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}  # Token bot t·ª´ secrets
      CHAT_ID: ${{ secrets.CHAT_ID }}  # ID chat t·ª´ secrets
      DAILY_LIMIT: 100000  # Gi·ªõi h·∫°n h√†ng ng√†y cho c√°c y√™u c·∫ßu

    steps:
      - name: Check out the repository  # B∆∞·ªõc checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20  # C√†i ƒë·∫∑t Node.js phi√™n b·∫£n 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq  # C√†i ƒë·∫∑t jq ƒë·ªÉ x·ª≠ l√Ω JSON
        run: sudo apt-get install -y jq

      - name: Query Cloudflare API and Send Telegram Message  # Truy v·∫•n API v√† g·ª≠i tin nh·∫Øn Telegram
        run: |
          # L·∫•y ng√†y gi·ªù hi·ªán t·∫°i
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          START_DATE=$(echo $DATE | sed 's/T.*//')T00:00:00.000Z
          END_DATE=$(echo $DATE)

          # ƒê·ªãnh nghƒ©a query GraphQL
          QUERY='query getBillingMetrics($accountTag: String!, $filter: AccountWorkersInvocationsAdaptiveFilter_InputObject, $overviewFilter: AccountWorkersInvocationsAdaptiveFilter_InputObject) {
            viewer {
              accounts(filter: {accountTag: $accountTag}) {
                workersInvocationsAdaptive(limit: 10000, filter: $filter) {
                  sum {
                    duration
                    requests
                    subrequests
                    responseBodySize
                    errors
                  }
                  quantiles {
                    cpuTimeP50
                  }
                  dimensions {
                    usageModel
                  }
                }
                workersOverviewRequestsAdaptiveGroups(limit: 1000, filter: $overviewFilter) {
                  sum {
                    cpuTimeUs
                  }
                  dimensions {
                    usageModel
                  }
                }
                durableObjectsInvocationsAdaptiveGroups(limit: 10000, filter: $durableObjectFilter) {
                  sum {
                    requests
                  }
                }
                durableObjectsPeriodicGroups(limit: 10000, filter: $durableObjectFilter) {
                  sum {
                    activeTime
                  }
                }
              }
            }
          }'

          # G·ª≠i request t·ªõi Cloudflare API
          RESPONSE=$(curl -s -X POST 'https://api.cloudflare.com/client/v4/graphql' \
            -H 'Content-Type: application/json' \
            -H "X-Auth-Email: $API_EMAIL" \
            -H "X-Auth-Key: $API_KEY" \
            --data-raw "$(jq -n \
              --arg accountTag "$ACCOUNT_ID" \
              --arg startDate "$START_DATE" \
              --arg endDate "$END_DATE" \
              --argjson filter "{\"datetime_geq\": \"$START_DATE\", \"datetime_leq\": \"$END_DATE\"}" \
              --argjson overviewFilter "{\"datetime_geq\": \"$START_DATE\", \"datetime_leq\": \"$END_DATE\"}" \
              --argjson durableObjectFilter "{\"datetimeHour_geq\": \"$START_DATE\", \"datetimeHour_leq\": \"$END_DATE\"}" \
              --arg query "$QUERY" \
              '{query: $query, variables: {accountTag: $accountTag, filter: $filter, overviewFilter: $overviewFilter, durableObjectFilter: $durableObjectFilter}}')")

          echo "Cloudflare API Response: $RESPONSE"  # In ra ph·∫£n h·ªìi t·ª´ Cloudflare API

          # Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t√†i kho·∫£n kh√¥ng
          if [ "$(echo $RESPONSE | jq -r '.data.viewer.accounts | length')" -eq 0 ]; then
            echo "No accounts data found. Please check your ACCOUNT_ID."
            exit 1
          fi

          # L·∫•y s·ªë l∆∞·ª£ng requests
          REQUESTS=$(echo $RESPONSE | jq '.data.viewer.accounts[0].workersInvocationsAdaptive[0].sum.requests // 0')
          if [ "$REQUESTS" == "null" ]; then
            echo "No request data found. Please check your query and ensure there is data in the specified time range."
            exit 1
          fi

          # T√≠nh ph·∫ßn trƒÉm s·ª≠ d·ª•ng
          USAGE_PERCENTAGE=$(echo "scale=2; ($REQUESTS / $DAILY_LIMIT) * 100" | bc)

          # ƒê·ªãnh d·∫°ng ng√†y gi·ªù v√† tin nh·∫Øn
          FORMATTED_DATE=$(TZ=Asia/Ho_Chi_Minh date +"%d-%m-%Y %H:%M:%S")
          MESSAGE=$(printf "‚è∞ Th√¥ng b√°o l√∫c: %s\n‚úÖ S·ªë l∆∞·ª£ng truy v·∫•n: %d / %d\nüíØ Ph·∫ßn trƒÉm s·ª≠ d·ª•ng: %.2f%%" "$FORMATTED_DATE" "$REQUESTS" "$DAILY_LIMIT" "$USAGE_PERCENTAGE")
          ENCODED_MESSAGE=$(echo "$MESSAGE" | jq -sRr @uri)

          # G·ª≠i tin nh·∫Øn t·ªõi Telegram
          TELEGRAM_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID&text=$ENCODED_MESSAGE")

          # Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ Telegram
          if [ "$(echo $TELEGRAM_RESPONSE | jq -r '.ok')" != "true" ]; then
            echo "Failed to send Telegram message."
            exit 1
          fi

          echo "Message sent successfully!"  # In ra th√¥ng b√°o g·ª≠i tin nh·∫Øn th√†nh c√¥ng
